// ========================================
// 회비 정산 관리 시스템
// ========================================

enum PaymentRecordStatus {
  PENDING   // 대기
  MATCHED   // 매칭됨
  ERROR     // 에러
  CONFIRMED // 확정
  SKIPPED   // 건너뜀
}

// 연도별 회비 설정
model MembershipFee {
  id            Int      @id @default(autoincrement())
  clubId        Int
  year          Int
  regularAmount Int      // 일반 회비 (예: 25000)
  coupleAmount  Int      // 부부 회비 (예: 45000)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  club Club @relation(fields: [clubId], references: [id], onDelete: Cascade)

  @@unique([clubId, year])
  @@index([clubId])
}

// 부부 그룹
model CoupleGroup {
  id        Int      @id @default(autoincrement())
  clubId    Int
  createdAt DateTime @default(now())

  // Relations
  club    Club          @relation(fields: [clubId], references: [id], onDelete: Cascade)
  members CoupleMember[]

  @@index([clubId])
}

// 부부 그룹 멤버
model CoupleMember {
  id            Int      @id @default(autoincrement())
  coupleGroupId Int
  clubMemberId  Int      @unique // 1인 1그룹만 허용
  createdAt     DateTime @default(now())

  // Relations
  coupleGroup CoupleGroup @relation(fields: [coupleGroupId], references: [id], onDelete: Cascade)
  clubMember  ClubMember  @relation(fields: [clubMemberId], references: [id], onDelete: Cascade)

  @@index([coupleGroupId])
}

// 회비 면제
model FeeExemption {
  id           Int      @id @default(autoincrement())
  clubMemberId Int
  year         Int
  reason       String   // 면제 사유 (예: "임원")
  createdAt    DateTime @default(now())
  createdById  Int

  // Relations
  clubMember ClubMember @relation("FeeExemptionMember", fields: [clubMemberId], references: [id], onDelete: Cascade)
  createdBy  ClubMember @relation("FeeExemptionCreator", fields: [createdById], references: [id])

  @@unique([clubMemberId, year])
  @@index([clubMemberId])
  @@index([year])
}

// 입금 내역 배치 (엑셀 업로드 단위)
model PaymentUploadBatch {
  id           String   @id @default(cuid())
  clubId       Int
  uploadedAt   DateTime @default(now())
  uploadedById Int
  fileName     String
  recordCount  Int

  // Relations
  club       Club           @relation(fields: [clubId], references: [id], onDelete: Cascade)
  uploadedBy ClubMember     @relation(fields: [uploadedById], references: [id])
  records    PaymentRecord[]

  @@index([clubId])
  @@index([uploadedById])
}

// 입금 내역 (엑셀 파싱 결과)
model PaymentRecord {
  id              String              @id @default(cuid())
  batchId         String
  clubId          Int
  transactionDate DateTime
  depositorName   String
  amount          Int
  memo            String?
  matchedMemberId Int?
  status          PaymentRecordStatus @default(PENDING)
  errorReason     String?
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  // Relations
  batch         PaymentUploadBatch @relation(fields: [batchId], references: [id], onDelete: Cascade)
  club          Club               @relation(fields: [clubId], references: [id], onDelete: Cascade)
  matchedMember ClubMember?        @relation(fields: [matchedMemberId], references: [id])
  payments      MembershipPayment[]

  @@index([batchId])
  @@index([clubId])
  @@index([matchedMemberId])
  @@index([status])
}

// 납부 내역 (확정된 회비 납부)
model MembershipPayment {
  id               String   @id @default(cuid())
  clubMemberId     Int
  paymentRecordId  String
  year             Int
  month            Int
  amount           Int
  confirmedAt      DateTime @default(now())
  confirmedById    Int

  // Relations
  clubMember    ClubMember    @relation("MembershipPaymentMember", fields: [clubMemberId], references: [id], onDelete: Cascade)
  paymentRecord PaymentRecord @relation(fields: [paymentRecordId], references: [id], onDelete: Cascade)
  confirmedBy   ClubMember    @relation("MembershipPaymentConfirmer", fields: [confirmedById], references: [id])

  @@unique([clubMemberId, year, month])
  @@index([clubMemberId])
  @@index([paymentRecordId])
  @@index([year])
}
