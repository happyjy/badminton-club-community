generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
} 

enum HelperType {
  NET
  FLOOR
  SHUTTLE
  KEY
  MOP
}

enum GuestStatus {
  PENDING   // 대기중
  APPROVED  // 승인됨
  REJECTED  // 거절됨
} 

enum MemberRole {
  ADMIN     // 임원
  MEMBER    // 회원
}

enum GuestPostType {
  GUEST_REQUEST    // 게스트 요청
  INQUIRY_REQUEST  // 문의하기 요청(현재 사용하지 않고 있음, 추후 사용 예정)
  JOIN_INQUIRY_REQUEST  // 가입 문의하기 요청
}

enum NotificationType {
  STATUS_UPDATE    // 승인/거절 상태 업데이트
  COMMENT_ADDED    // 댓글 추가
}

model User {
  id                  Int                  @id @default(autoincrement())
  kakaoId             String               @unique @default("")
  email               String               @unique
  nickname            String               @default("")
  thumbnailImageUrl   String               @default("")
  phoneNumber         String?              // 전화번호 필드 추가
  phoneVerifiedAt     DateTime?            // 전화번호 인증 완료 시간
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @default(now()) @updatedAt
  
  // Relations
  clubMember          ClubMember[]
  WorkoutParticipant  WorkoutParticipant[]
  guestPosts          GuestPost[]
  guestComments       GuestComment[]
  phoneVerifications  PhoneVerification[]  // 전화번호 인증 관계 추가
  smsNotificationLogs SmsNotificationLog[] // SMS 알림 로그 관계 추가
} 

model Club { 
  id            Int          @id @default(autoincrement())
  name          String
  description   String?
  location      String
  meetingTime   String
  maxMembers    Int
  etc           String?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  // 관계 필드 설정
  members            ClubMember[]
  workouts           Workout[]
  guestPosts         GuestPost[]
  
  // Relations
  clubCustomSettings   ClubCustomSettings?  @relation("ClubToSettings")
  phoneVerifications  PhoneVerification[]
  postCategories      PostCategory[]       @relation("ClubToPostCategory")
  posts               Post[]               @relation("ClubToPost")
  // 회비 정산
  membershipFees      MembershipFee[]
  coupleGroups        CoupleGroup[]
  paymentUploadBatches PaymentUploadBatch[]
  paymentRecords      PaymentRecord[]

}

model ClubMember {
  id                       Int      @id @default(autoincrement())
  clubId                   Int
  userId                   Int
  role                     String   @default("MEMBER")
  status                   String   @default("PENDING")
  name                     String?
  birthDate                String?
  phoneNumber              String   @default("010-0000-0000")
  gender                   String?
  localTournamentLevel     String?
  nationalTournamentLevel  String?
  lessonPeriod             String?
  playingPeriod            String?
  createdAt                DateTime @default(now())
  updatedAt                DateTime @updatedAt

  // Relations
  guestComments            GuestComment[]
  workoutParticipants      WorkoutParticipant[]
  club                     Club                  @relation(fields: [clubId], references: [id])
  user                     User                  @relation(fields: [userId], references: [id])
  helperStatuses           WorkoutHelperStatus[] @relation("HelperClubMember")
  updatedHelperStatuses    WorkoutHelperStatus[] @relation("HelperUpdater")
  createdGuestPosts        GuestPost[]           @relation("CreatedByClubMember")
  posts                    Post[]                @relation("PostAuthor")
  postComments             PostComment[]         @relation("PostCommentAuthor")
  // 회비 정산
  coupleMembers            CoupleMember[]
  feeExemptionsAsMember    FeeExemption[]        @relation("FeeExemptionMember")
  feeExemptionsAsCreator   FeeExemption[]        @relation("FeeExemptionCreator")
  paymentUploadBatches     PaymentUploadBatch[]
  matchedPaymentRecords    PaymentRecord[]
  membershipPaymentsAsMember   MembershipPayment[] @relation("MembershipPaymentMember")
  membershipPaymentsAsConfirmer MembershipPayment[] @relation("MembershipPaymentConfirmer")

  @@unique([clubId, userId])
} 


// 게시판 카테고리
model PostCategory {
  id            Int      @id @default(autoincrement())
  clubId        Int
  name          String
  description   String?
  allowedRoles  String[] @default(["MEMBER", "ADMIN"])
  order         Int      @default(0)
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  club          Club     @relation("ClubToPostCategory", fields: [clubId], references: [id], onDelete: Cascade)
  posts         Post[]
  
  @@index([clubId])
  @@index([clubId, isActive])
}

// 게시글
model Post {
  id            String        @id @default(cuid())
  clubId        Int
  categoryId    Int
  title         String
  content       String
  authorId      Int
  isPinned      Boolean       @default(false)
  viewCount     Int           @default(0)
  likeCount     Int           @default(0)
  isDeleted     Boolean       @default(false)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  
  club          Club          @relation("ClubToPost", fields: [clubId], references: [id], onDelete: Cascade)
  category      PostCategory  @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  author        ClubMember    @relation("PostAuthor", fields: [authorId], references: [id])
  comments      PostComment[]
  
  @@index([clubId])
  @@index([categoryId])
  @@index([authorId])
  @@index([clubId, categoryId, isDeleted])
  @@index([clubId, isPinned, isDeleted])
}

// 게시글 댓글
model PostComment {
  id            String        @id @default(cuid())
  postId        String
  authorId      Int?
  content       String
  parentId      String?
  isDeleted     Boolean       @default(false)
  likeCount     Int           @default(0)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  
  post          Post          @relation(fields: [postId], references: [id], onDelete: Cascade)
  author        ClubMember?   @relation("PostCommentAuthor", fields: [authorId], references: [id])
  parent        PostComment?  @relation("CommentToComment", fields: [parentId], references: [id])
  children      PostComment[] @relation("CommentToComment")
  
  @@index([postId])
  @@index([authorId])
  @@index([parentId])
  @@index([postId, isDeleted])
}


model Workout {
  id                  Int                  @id @default(autoincrement())
  title               String
  description         String               @default("")
  date                DateTime
  startTime           DateTime
  endTime             DateTime
  maxParticipants     Int
  location            String
  createdAt           DateTime             @default(now())
  updatedAt           DateTime
  clubId              Int?
  
  // Relations
  club                Club?                @relation(fields: [clubId], references: [id])
  WorkoutParticipant  WorkoutParticipant[]
  helperStatuses      WorkoutHelperStatus[]
}

model WorkoutParticipant {
  id              Int         @id @default(autoincrement())
  workoutId       Int
  userId          Int
  clubMemberId    Int?
  status          String      @default("PENDING")
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  
  // Relations
  User            User        @relation(fields: [userId], references: [id])
  clubMember      ClubMember? @relation(fields: [clubMemberId], references: [id])
  Workout         Workout     @relation(fields: [workoutId], references: [id])

  @@unique([workoutId, userId])
}

model WorkoutHelperStatus {
  id           Int        @id @default(autoincrement())
  workoutId    Int
  clubMemberId Int
  helperType   HelperType
  helped       Boolean    @default(false)
  updatedById  Int
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  // Relations
  workout      Workout    @relation(fields: [workoutId], references: [id])
  clubMember   ClubMember @relation("HelperClubMember", fields: [clubMemberId], references: [id])
  updatedBy    ClubMember @relation("HelperUpdater", fields: [updatedById], references: [id])

  @@unique([workoutId, clubMemberId, helperType])
} 

// 게스트 신청 게시글
model GuestPost {
  id                       String                @id @default(cuid()) 
  clubId                   Int                                           // 게스트 신청한 클럽 ID
  userId                   Int                                           // 게스트 신청한 유저 ID
  postType                 GuestPostType         @default(GUEST_REQUEST) // 게시글 타입 (게스트 요청 또는 문의하기 요청)
  name                     String       
  birthDate                String                @default("")
  phoneNumber              String       
  gender                   String                @default("")            // 성별 필드 추가
  localTournamentLevel     String                @default("")
  nationalTournamentLevel  String                @default("")
  lessonPeriod             String                @default("")
  playingPeriod            String                @default("")
  status                   GuestStatus           @default(PENDING)
  // 클럽 가입 필드에서 게스트 신청시 추가        된 필드
  intendToJoin             Boolean               @default(false)
  visitDate                String                @default("")
  message                  String                @default("")
  // 게스트 신청 게시글 작성자       
  createdBy                Int?       
  createdAt                DateTime              @default(now())
  // 업데이트        
  updatedBy                Int                   @default(0)
  updatedAt                DateTime              @default(now()) @updatedAt
        
  // Relations       
  club                     Club                  @relation(fields: [clubId], references: [id]) // 게스트 신청 게시글 작성 클럽
  user                     User                  @relation(fields: [userId], references: [id]) // 게스트 신청 게시글 작성자
  clubMember               ClubMember?           @relation("CreatedByClubMember", fields: [createdBy], references: [id]) // 게스트 신청 게시글 작성자 클럽 멤버
  comments                 GuestComment[]
  smsNotificationLogs      SmsNotificationLog[] // SMS 알림 로그 관계 추가

  @@index([clubId])
  @@index([userId])
  @@index([createdBy])
}

// 게스트 신청 댓글
model GuestComment {
  id            String          @id @default(cuid())
  postId        String      
  userId        Int?            // 회원 ID(작성자-회원가입전)
  clubMemberId  Int?            // 클럽 멤버 ID(임원진)
  content       String
  parentId      String?
  isDeleted     Boolean         @default(false)
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @default(now()) @updatedAt
  
  // Relations
  user          User?           @relation(fields: [userId], references: [id])
  clubMember    ClubMember?     @relation(fields: [clubMemberId], references: [id])
  post          GuestPost       @relation(fields: [postId], references: [id], onDelete: Cascade)
  parent        GuestComment?   @relation("CommentToComment", fields: [parentId], references: [id])
  children      GuestComment[]  @relation("CommentToComment")
  
  @@index([postId])
  @@index([userId])
  @@index([clubMemberId])
  @@index([parentId])
} 

// 마이그레이션 코드
model GuestPost_copy {
  id                       String         @id @default(cuid()) 
  clubId                   Int            
  userId                   Int            
  name                     String
  message                  String
  status                   GuestStatus    @default(PENDING)
  createdAt                DateTime       @default(now())
  updatedAt                DateTime       @updatedAt
  phoneNumber              String         @default("")
  gender                   String         @default("")          // 성별 필드 추가
  
  // 신규 필드들은 기본값 설정으로 추가
  birthDate                String         @default("")
  localTournamentLevel     String         @default("")
  nationalTournamentLevel  String         @default("")
  lessonPeriod             String         @default("")
  playingPeriod            String         @default("")
    
  @@index([clubId])
  @@index([userId])
}

// 클럽 커스텀 설정
model ClubCustomSettings {
  id                   Int      @id @default(autoincrement())
  clubId               Int      @unique
  // 클럽 홈 설명 설정
  clubOperatingTime    String?  // 운영 시간
  clubLocation         String?  // 장소
  clubDescription      String?  // 설명
  
  // 문의하기/게스트 신청 설명글 설정
  inquiryDescription   String?  // 클럽 문의하기 설명
  guestDescription     String?  // 게스트 신청 설명
  
  // 이메일 발송 설정
  emailRecipients      String[] // 이메일 수신자 목록 (JSON 배열로 저장)
  
  // 문자 발송 설정
  smsRecipients        String[] // 문자 수신자 목록 (JSON 배열로 저장)
  
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  // Relations
  club                Club     @relation("ClubToSettings", fields: [clubId], references: [id], onDelete: Cascade)
  @@index([clubId])
}

// 전화번호 인증
model PhoneVerification {
  id                Int       @id @default(autoincrement())
  userId            Int
  clubId            Int
  phoneNumber       String
  verificationCode  String    @db.VarChar(6)
  isVerified        Boolean   @default(false)
  expiresAt         DateTime
  verifiedAt        DateTime?
  createdAt         DateTime  @default(now())

  // Relations
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  club              Club      @relation(fields: [clubId], references: [id], onDelete: Cascade)

  @@unique([userId, clubId, phoneNumber])
  @@index([userId, clubId])
  @@index([expiresAt])
} 

// SMS 알림 로그
model SmsNotificationLog {
  id                 Int                @id @default(autoincrement())
  guestPostId        String             // 게스트 신청 게시글 ID
  userId             Int                // 문자를 받을 사용자 ID
  notificationType   NotificationType   // 알림 타입
  sentAt             DateTime           @default(now())

  // Relations
  guestPost          GuestPost          @relation(fields: [guestPostId], references: [id], onDelete: Cascade)
  user               User               @relation(fields: [userId], references: [id])

  @@unique([guestPostId, userId, notificationType]) // 중복 전송 방지(guestPostId, userId, notificationType 필드가 모두 같은 경우 중복 전송 방지)
  @@index([guestPostId])
  @@index([userId])
}


// ========================================
// 회비 정산 관리 시스템
// ========================================

enum PaymentRecordStatus {
  PENDING   // 대기
  MATCHED   // 매칭됨
  ERROR     // 에러
  CONFIRMED // 확정
  SKIPPED   // 건너뜀
}

// 연도별 회비 설정
model MembershipFee {
  id            Int      @id @default(autoincrement())
  clubId        Int
  year          Int
  regularAmount Int      // 일반 회비 (예: 25000)
  coupleAmount  Int      // 부부 회비 (예: 45000)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  club Club @relation(fields: [clubId], references: [id], onDelete: Cascade)

  @@unique([clubId, year])
  @@index([clubId])
}

// 부부 그룹
model CoupleGroup {
  id        Int      @id @default(autoincrement())
  clubId    Int
  createdAt DateTime @default(now())

  // Relations
  club    Club          @relation(fields: [clubId], references: [id], onDelete: Cascade)
  members CoupleMember[]

  @@index([clubId])
}

// 부부 그룹 멤버
model CoupleMember {
  id            Int      @id @default(autoincrement())
  coupleGroupId Int
  clubMemberId  Int      @unique // 1인 1그룹만 허용
  createdAt     DateTime @default(now())

  // Relations
  coupleGroup CoupleGroup @relation(fields: [coupleGroupId], references: [id], onDelete: Cascade)
  clubMember  ClubMember  @relation(fields: [clubMemberId], references: [id], onDelete: Cascade)

  @@index([coupleGroupId])
}

// 회비 면제
model FeeExemption {
  id           Int      @id @default(autoincrement())
  clubMemberId Int
  year         Int
  reason       String   // 면제 사유 (예: "임원")
  createdAt    DateTime @default(now())
  createdById  Int

  // Relations
  clubMember ClubMember @relation("FeeExemptionMember", fields: [clubMemberId], references: [id], onDelete: Cascade)
  createdBy  ClubMember @relation("FeeExemptionCreator", fields: [createdById], references: [id])

  @@unique([clubMemberId, year])
  @@index([clubMemberId])
  @@index([year])
}

// 입금 내역 배치 (엑셀 업로드 단위)
model PaymentUploadBatch {
  id           String   @id @default(cuid())
  clubId       Int
  uploadedAt   DateTime @default(now())
  uploadedById Int
  fileName     String
  recordCount  Int

  // Relations
  club       Club           @relation(fields: [clubId], references: [id], onDelete: Cascade)
  uploadedBy ClubMember     @relation(fields: [uploadedById], references: [id])
  records    PaymentRecord[]

  @@index([clubId])
  @@index([uploadedById])
}

// 입금 내역 (엑셀 파싱 결과)
model PaymentRecord {
  id              String              @id @default(cuid())
  batchId         String
  clubId          Int
  transactionDate DateTime
  depositorName   String
  amount          Int
  memo            String?
  matchedMemberId Int?
  status          PaymentRecordStatus @default(PENDING)
  errorReason     String?
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  // Relations
  batch         PaymentUploadBatch @relation(fields: [batchId], references: [id], onDelete: Cascade)
  club          Club               @relation(fields: [clubId], references: [id], onDelete: Cascade)
  matchedMember ClubMember?        @relation(fields: [matchedMemberId], references: [id])
  payments      MembershipPayment[]

  @@index([batchId])
  @@index([clubId])
  @@index([matchedMemberId])
  @@index([status])
}

// 납부 내역 (확정된 회비 납부)
model MembershipPayment {
  id               String   @id @default(cuid())
  clubMemberId     Int
  paymentRecordId  String
  year             Int
  month            Int
  amount           Int
  confirmedAt      DateTime @default(now())
  confirmedById    Int

  // Relations
  clubMember    ClubMember    @relation("MembershipPaymentMember", fields: [clubMemberId], references: [id], onDelete: Cascade)
  paymentRecord PaymentRecord @relation(fields: [paymentRecordId], references: [id], onDelete: Cascade)
  confirmedBy   ClubMember    @relation("MembershipPaymentConfirmer", fields: [confirmedById], references: [id])

  @@unique([clubMemberId, year, month])
  @@index([clubMemberId])
  @@index([paymentRecordId])
  @@index([year])
}


