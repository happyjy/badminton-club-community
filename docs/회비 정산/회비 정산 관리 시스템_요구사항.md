# 회비 정산 관리 시스템 - 요구사항

## 1. 개요

| 항목   | 내용                       |
| ------ | -------------------------- |
| 목적   | 클럽 회비 납부 관리 자동화 |
| 대상   | 당산클럽 회원 약 90명      |
| 관리자 | 총무                       |

---

## 2. 회원 유형 및 회비

| 유형      | 월 회비  | 유효 입금액   | 비고                    |
| --------- | -------- | ------------- | ----------------------- |
| 일반 회원 | 25,000원 | 25,000원 배수 |                         |
| 부부 회원 | 45,000원 | 45,000원 배수 | 약 10쌍, 한 행으로 표시 |
| 임원      | 면제     | -             | 회비 납부 의무 없음     |

---

## 3. 입금 처리 규칙

| 규칙      | 내용                                               |
| --------- | -------------------------------------------------- |
| 선납      | 허용 (미래 월 납부 가능)                           |
| 후납      | 허용                                               |
| 금액 검증 | 회원 유형에 맞는 배수가 아니면 에러 처리           |
| 입금자명  | 회원 이름과 다를 수 있음 (성 생략, 부부 중 1명 등) |

### 금액 예시

```
일반 회원:
  - 25,000원 → ✅ 1개월
  - 50,000원 → ✅ 2개월
  - 30,000원 → ❌ 에러

부부 회원:
  - 45,000원 → ✅ 1개월
  - 90,000원 → ✅ 2개월
  - 50,000원 → ❌ 에러
```

---

## 4. 기능 목록

### 4.1 설정 기능

| 기능           | 설명                       |
| -------------- | -------------------------- |
| 부부 회원 설정 | 두 회원을 부부로 묶기/해제 |
| 회비 면제 설정 | 임원 등 면제 대상 지정     |

### 4.2 입금 처리 (하이브리드 방식)

| 단계         | 처리 방식                               |
| ------------ | --------------------------------------- |
| 1. 업로드    | 카카오뱅크 엑셀 파일 업로드             |
| 2. 자동 파싱 | 거래내역 추출                           |
| 3. 자동 매칭 | 입금자명 → 회원 매칭 시도               |
| 4. 자동 제안 | 금액 검증 + 배정 월 제안 (미납 월 기준) |
| 5. 총무 확인 | 매칭 결과 검토, 필요시 수정             |
| 6. 확정      | 납부 내역으로 저장                      |

### 4.3 대시보드

| 기능             | 설명                   |
| ---------------- | ---------------------- |
| 회원별 납부 현황 | 90명 × 12개월 매트릭스 |
| 월별 납부율      | 해당 월 납부 완료 비율 |
| 미납자 목록      | 미납 회원 조회         |

### 4.4 정산 리포트

| 기능        | 설명                |
| ----------- | ------------------- |
| 월별 수입   | 월별 납부 금액 집계 |
| 연간 수입   | 연간 누적 금액      |
| 납부율 통계 | 회원별/월별 납부율  |

---

## 5. 화면 목록

| 화면               | 용도                            |
| ------------------ | ------------------------------- |
| 부부 회원 관리     | 부부 등록/해제                  |
| 회비 면제 관리     | 임원 면제 설정                  |
| 거래내역 업로드    | 엑셀 업로드                     |
| 매칭 확인/처리     | 자동 매칭 결과 검토, 수정, 확정 |
| 납부 현황 대시보드 | 회원×월 납부 현황 표            |
| 정산 리포트        | 월별/연간 수입 집계             |

---

## 6. 화면 와이어프레임

### 6.1 부부 회원 관리

```
┌────────────────────────────────────────────────────────┐
│  👥 부부 회원 관리                         [+ 부부 등록] │
├────────────────────────────────────────────────────────┤
│                                                        │
│  1. 김철수 · 이영희          월 45,000원    [해제]      │
│  2. 박민수 · 최지연          월 45,000원    [해제]      │
│  3. 정우성 · 김태희          월 45,000원    [해제]      │
│                                                        │
└────────────────────────────────────────────────────────┘

┌─────────────────────────────────────┐
│  부부 등록                    [닫기] │
├─────────────────────────────────────┤
│                                     │
│  회원 1: [김철수 ▼]                 │
│  회원 2: [이영희 ▼]                 │
│                                     │
│  [등록]                             │
│                                     │
└─────────────────────────────────────┘
```

### 6.2 거래내역 업로드

```
┌────────────────────────────────────────────┐
│  📤 거래내역 업로드                          │
├────────────────────────────────────────────┤
│  [카카오뱅크 엑셀 파일 선택]  [업로드]        │
│                                            │
│  최근 업로드: 2025-02-01 (32건)             │
└────────────────────────────────────────────┘
```

### 6.3 매칭 확인/처리

```
┌──────────────────────────────────────────────────────────┐
│  📋 입금 내역 처리                    [전체 확정]         │
├────────┬────────┬────────┬──────────┬─────────┬─────────┤
│ 입금일  │ 입금자  │ 금액    │ 매칭 회원  │ 배정 월  │ 상태   │
├────────┼────────┼────────┼──────────┼─────────┼─────────┤
│ 01-15  │ 김철수  │ 25,000 │ 김철수 ✓ │ [1월 ▼] │ ✅ 확정 │
│ 01-16  │ 영희   │ 50,000 │ [선택 ▼] │ 1,2월   │ ⚠️ 확인 │
│ 01-17  │ 박민수  │ 30,000 │ 박민수   │ -       │ ❌ 에러 │
└────────┴────────┴────────┴──────────┴─────────┴─────────┘
                                    금액이 25,000원 배수 아님
```

### 6.4 납부 현황 대시보드

```
┌─────────────────────────────────────────────────────────────────┐
│  📊 2025년 회비 납부 현황                        [엑셀 다운로드] │
├─────────┬────┬────┬────┬────┬────┬─────────────────────────────┤
│ 회원     │ 1월│ 2월│ 3월│ 4월│ ...│ 납부율                      │
├─────────┼────┼────┼────┼────┼────┼─────────────────────────────┤
│ 김철수   │ ✅ │ ✅ │ ⬜ │ ⬜ │    │ 2/2 (100%)                  │
│ 이영희   │ ✅ │ ⬜ │ ⬜ │ ⬜ │    │ 1/2 (50%)                   │
│ 박민수   │ ⬜ │ ⬜ │ ⬜ │ ⬜ │    │ 0/2 (0%) ← 미납             │
│ 최회장   │ 🔷 │ 🔷 │ 🔷 │ 🔷 │    │ 면제 (임원)                 │
│ 김철수·이영희 │ ✅ │ ✅ │ ⬜ │ ⬜ │  │ 2/2 (100%) ← 부부          │
├─────────┴────┴────┴────┴────┴────┴─────────────────────────────┤
│ 월 합계  │ 80 │ 75 │    │    │    │ 총 납부: 3,875,000원        │
└─────────────────────────────────────────────────────────────────┘
```

### 6.5 정산 리포트

```
┌────────────────────────────────────────────┐
│  📈 2025년 정산 리포트                      │
├────────────────────────────────────────────┤
│  총 회원: 90명 (면제 5명 제외: 85명)        │
│  월 예상 수입: 2,125,000원                 │
│                                            │
│  월별 수입                                  │
│  ├─ 1월: 2,000,000원 (94%)                │
│  ├─ 2월: 1,875,000원 (88%)                │
│  └─ ...                                   │
│                                            │
│  연간 누적: 3,875,000원                    │
└────────────────────────────────────────────┘
```

---

## 7. DB 스키마 (안)

```prisma
// 연도별 회비 설정
model MembershipFee {
  id          String   @id @default(cuid())
  clubId      String
  year        Int      // 2025
  monthlyAmount Int    // 25000
  createdAt   DateTime @default(now())

  club        Club     @relation(fields: [clubId], references: [id])
}

// 부부 그룹
model CoupleGroup {
  id          String   @id @default(cuid())
  clubId      String
  createdAt   DateTime @default(now())

  club        Club     @relation(fields: [clubId], references: [id])
  members     ClubMember[]
}

// ClubMember 확장
model ClubMember {
  // 기존 필드...
  coupleGroupId  String?      // nullable, 부부면 같은 그룹 ID
  monthlyFee     Int          // 개인: 25000, 부부: 45000

  coupleGroup    CoupleGroup? @relation(fields: [coupleGroupId], references: [id])
}

// 회비 면제 설정 (임원 등)
model FeeExemption {
  id            String   @id @default(cuid())
  clubMemberId  String
  year          Int
  reason        String   // "임원"
  createdAt     DateTime @default(now())

  clubMember    ClubMember @relation(fields: [clubMemberId], references: [id])
}

// 입금 내역 (엑셀에서 파싱된 원본)
model PaymentRecord {
  id              String   @id @default(cuid())
  clubId          String
  transactionDate DateTime // 입금일
  depositorName   String   // 입금자명 (원본)
  amount          Int      // 금액
  memo            String?  // 적요
  matchedMemberId String?  // 매칭된 회원 (nullable)
  status          PaymentRecordStatus // PENDING | MATCHED | ERROR | CONFIRMED
  errorReason     String?  // "금액 불일치" 등
  createdAt       DateTime @default(now())

  club            Club     @relation(fields: [clubId], references: [id])
  matchedMember   ClubMember? @relation(fields: [matchedMemberId], references: [id])
  payments        MembershipPayment[]
}

enum PaymentRecordStatus {
  PENDING
  MATCHED
  ERROR
  CONFIRMED
}

// 회비 납부 내역 (확정된 것)
model MembershipPayment {
  id              String   @id @default(cuid())
  clubMemberId    String
  paymentRecordId String   // 원본 입금 내역 참조
  year            Int
  month           Int      // 1~12
  amount          Int      // 25000 또는 45000
  confirmedAt     DateTime
  confirmedBy     String   // 총무 userId

  clubMember      ClubMember    @relation(fields: [clubMemberId], references: [id])
  paymentRecord   PaymentRecord @relation(fields: [paymentRecordId], references: [id])
}
```

---

## 8. 구현 순서

| 순서 | 기능               | 설명                      |
| ---- | ------------------ | ------------------------- |
| 1    | DB 스키마          | Prisma 모델 추가          |
| 2    | 회비 면제 설정     | 임원 면제 기능            |
| 3    | 부부 회원 설정     | 부부 등록/해제            |
| 4    | 엑셀 파서          | 카카오뱅크 거래내역 파싱  |
| 5    | 회원 매칭 로직     | 입금자명 → 회원 자동 매칭 |
| 6    | 금액 검증 로직     | 회원 유형별 배수 검증     |
| 7    | 매칭 확인 UI       | 총무 확인/수정/확정 화면  |
| 8    | 납부 현황 대시보드 | 회원×월 매트릭스          |
| 9    | 정산 리포트        | 월별/연간 집계            |

---

## 9. 보류/향후 기능

| 기능                | 상태 | 비고               |
| ------------------- | ---- | ------------------ |
| 미납자 알림 발송    | 보류 | 추후 구현          |
| 카카오뱅크 API 연동 | 불가 | 엑셀 업로드로 대체 |

---

## 10. 참고사항

- 입금 방식: 카카오뱅크 비즈니스 계좌 (카카오페이 송금 + 계좌이체)
- 현재 관리 방식: 엑셀 수동 관리
- 납부 기한: 없음 (자율)
