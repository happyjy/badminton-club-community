기획서를 업데이트하겠습니다. 사용자 편의성을 높이는 중요한 기능이네요.

Read file: prisma/schema/user.prisma

# 전화번호 인증 기능 상세 기획서 (업데이트)

## 1. 문제 분석

### 현재 상황

- 클럽 가입 신청 시 전화번호 인증 없이 바로 신청 가능
- 잘못된 전화번호로 문자 전송 시 신고 위험 존재
- SENS 서비스 사용으로 인한 법적 책임 가능성
- **사용자가 매번 전화번호 인증을 반복해야 하는 불편함**

### 해결 필요성

- 전화번호 소유자 본인 확인을 통한 신청자 검증
- 스팸 신청 방지 및 클럽 관리자 부담 감소
- 법적 리스크 최소화
- **한 번 인증한 전화번호를 재사용하여 사용자 편의성 향상**

## 2. 기능 요구사항

### 2.1 핵심 기능

1. **전화번호 인증 프로세스**

   - 인증번호 발송 (6자리 숫자)
   - 인증번호 확인 (3분 제한시간)
   - 인증 성공 시에만 가입 신청 가능
   - **인증 완료 시 User 모델에 전화번호 저장**

2. **인증 상태 관리**

   - 인증 완료 상태 저장
   - 인증 만료 시간 관리
   - 재인증 기능
   - **이미 인증된 전화번호는 자동 인증 처리**

3. **사용자 편의성 기능**
   - **한 번 인증한 전화번호는 재인증 불필요**
   - **로그인 시 저장된 전화번호 자동 표시**
   - **전화번호 변경 시에만 재인증 필요**

### 2.2 사용자 경험

- 직관적인 UI/UX
- 명확한 진행 상태 표시
- 에러 상황에 대한 친화적 안내
- **인증 완료 후 다음 신청 시 자동 인증 상태 표시**

## 3. 기술 설계

### 3.1 데이터베이스 스키마 확장

#### 3.1.1 User 모델 수정

```sql
-- User 모델에 전화번호 필드 추가
ALTER TABLE User ADD COLUMN phoneNumber VARCHAR(20) NULL;
ALTER TABLE User ADD COLUMN phoneVerifiedAt TIMESTAMP NULL;

-- 인덱스 추가
CREATE INDEX idx_user_phone ON User(phoneNumber);
CREATE INDEX idx_user_phone_verified ON User(phoneNumber, phoneVerifiedAt);
```

#### 3.1.2 전화번호 인증 테이블 (임시 인증용)

```sql
-- 전화번호 인증 테이블 (임시 인증 과정용)
CREATE TABLE PhoneVerification (
  id SERIAL PRIMARY KEY,
  userId INTEGER NOT NULL,
  clubId INTEGER NOT NULL,
  phoneNumber VARCHAR(20) NOT NULL,
  verificationCode VARCHAR(6) NOT NULL,
  isVerified BOOLEAN DEFAULT FALSE,
  expiresAt TIMESTAMP NOT NULL,
  verifiedAt TIMESTAMP NULL,
  createdAt TIMESTAMP DEFAULT NOW(),

  FOREIGN KEY (userId) REFERENCES User(id),
  FOREIGN KEY (clubId) REFERENCES Club(id),

  UNIQUE(userId, clubId, phoneNumber)
);

-- 인덱스
CREATE INDEX idx_phone_verification_user_club ON PhoneVerification(userId, clubId);
CREATE INDEX idx_phone_verification_expires ON PhoneVerification(expiresAt);
```

### 3.2 API 엔드포인트 설계

#### 3.2.1 인증 상태 확인 API (업데이트)

```
GET /api/clubs/[id]/phone-verification/status
```

**Response:**

```json
{
  "success": true,
  "data": {
    "isVerified": true,
    "phoneNumber": "010-1234-5678",
    "verifiedAt": "2024-01-31T10:30:00Z",
    "isPreviouslyVerified": true, // 이전에 인증된 전화번호인지 여부
    "canSkipVerification": true // 인증 과정을 건너뛸 수 있는지 여부
  }
}
```

#### 3.2.2 전화번호 업데이트 API (신규)

```
PUT /api/users/me/phone
```

**Request Body:**

```json
{
  "phoneNumber": "010-1234-5678"
}
```

**Response:**

```json
{
  "success": true,
  "message": "전화번호가 업데이트되었습니다",
  "data": {
    "phoneNumber": "010-1234-5678",
    "phoneVerifiedAt": "2024-01-31T10:30:00Z"
  }
}
```

#### 3.2.3 인증번호 발송 API (업데이트)

```
POST /api/clubs/[id]/phone-verification/send
```

**Request Body:**

```json
{
  "phoneNumber": "010-1234-5678",
  "forceNewVerification": false // 강제로 새 인증을 받을지 여부
}
```

**Response:**

```json
{
  "success": true,
  "message": "인증번호가 발송되었습니다",
  "expiresIn": 180, // 3분
  "isPreviouslyVerified": false
}
```

### 3.3 컴포넌트 구조 (업데이트)

#### 3.3.1 PhoneVerificationStep 컴포넌트 (업데이트)

```typescript
interface PhoneVerificationStepProps {
  clubId: string;
  userPhoneNumber?: string; // 사용자 기존 전화번호
  onVerificationComplete: (phoneNumber: string) => void;
  onSkipVerification: (phoneNumber: string) => void; // 기존 인증된 전화번호 사용
  onBack: () => void;
}
```

#### 3.3.2 PhoneNumberDisplay 컴포넌트 (신규)

```typescript
interface PhoneNumberDisplayProps {
  phoneNumber: string;
  isVerified: boolean;
  verifiedAt?: Date;
  onChangePhone: () => void;
  onUseExisting: () => void;
}
```

## 4. UI/UX 설계 (업데이트)

### 4.1 인증 플로우 (업데이트)

1. **전화번호 확인 단계**

   - 기존 인증된 전화번호 표시
   - "기존 전화번호 사용" 버튼
   - "새 전화번호로 인증" 버튼

2. **전화번호 입력 단계** (새 전화번호 선택 시)

   - 전화번호 입력 필드
   - 인증번호 발송 버튼
   - 전화번호 형식 검증

3. **인증번호 입력 단계**

   - 6자리 인증번호 입력 필드
   - 타이머 표시 (3분 카운트다운)
   - 재발송 버튼
   - 인증 확인 버튼

4. **인증 완료 단계**
   - 인증 성공 메시지
   - User 모델에 전화번호 저장
   - 가입 신청 폼으로 진행

### 4.2 상태 관리 (업데이트)

- `CHECKING`: 기존 인증 상태 확인 중
- `PREVIOUSLY_VERIFIED`: 이전에 인증된 전화번호 존재
- `PENDING`: 인증번호 발송 대기
- `SENT`: 인증번호 발송 완료
- `VERIFYING`: 인증번호 확인 중
- `VERIFIED`: 인증 완료
- `EXPIRED`: 인증 만료
- `FAILED`: 인증 실패

## 5. 보안 고려사항 (업데이트)

### 5.1 인증번호 보안

- 6자리 랜덤 숫자 생성
- 3분 제한시간 설정
- 최대 3회 재발송 제한
- 인증 실패 시 5분 대기시간

### 5.2 요청 제한

- IP 기반 요청 제한 (분당 5회)
- 전화번호 기반 요청 제한 (시간당 3회)
- 동일 사용자 재인증 제한 (일 5회)

### 5.3 데이터 보호

- 인증번호 암호화 저장
- 만료된 인증 데이터 자동 삭제
- 로그 데이터 최소화
- **전화번호 정보 암호화 저장**

### 5.4 사용자 데이터 보호

- **전화번호 변경 시 재인증 필수**
- **인증된 전화번호만 User 모델에 저장**
- **개인정보 처리방침 준수**

## 6. 구현 단계 (업데이트)

### 6.1 1단계: 데이터베이스 스키마 수정

1. User 모델에 전화번호 필드 추가
   - 파일: `prisma/schema/user.prisma` (phoneNumber, phoneVerifiedAt 필드 추가)
2. PhoneVerification 테이블 생성
   - 파일: `prisma/schema/phoneVerification.prisma` (신규 파일)
3. 마이그레이션 스크립트 작성
   - 파일: `prisma/migrations/YYYYMMDDHHMMSS_add_phone_verification.sql`

### 6.2 2단계: 백엔드 API 구현

1. 인증 상태 확인 API 구현 (기존 인증 확인 로직 추가)
   - 파일: `src/pages/api/clubs/[id]/phone-verification/status.ts`
2. 인증번호 발송 API 구현 (기존 인증 확인 로직 추가)
   - 파일: `src/pages/api/clubs/[id]/phone-verification/send.ts`
3. 인증번호 확인 API 구현
   - 파일: `src/pages/api/clubs/[id]/phone-verification/verify.ts`
4. 전화번호 업데이트 API 구현
   - 파일: `src/pages/api/users/me/phone.ts`
5. User 모델 업데이트 로직 구현
   - 파일: `src/lib/user.ts` (신규 파일)

### 6.3 3단계: 프론트엔드 컴포넌트 구현

1. PhoneVerificationStep 컴포넌트 (기존 인증 확인 UI 추가)
   - 파일: `src/components/organisms/forms/PhoneVerificationStep.tsx`
2. PhoneNumberDisplay 컴포넌트 (신규)
   - 파일: `src/components/molecules/form/PhoneNumberDisplay.tsx`
3. VerificationCodeInput 컴포넌트
   - 파일: `src/components/molecules/form/VerificationCodeInput.tsx`
4. JoinClubModal 수정 (인증 단계 추가)
   - 파일: `src/components/organisms/modal/JoinClubModal.tsx`

### 6.4 4단계: 유틸리티 및 훅 구현

1. 전화번호 인증 관련 훅 구현
   - 파일: `src/hooks/usePhoneVerification.ts`
2. SMS 인증번호 관련 유틸리티 구현
   - 파일: `src/lib/sms-verification.ts`
3. SMS 라이브러리 확장 (인증번호 전송 기능 추가)
   - 파일: `src/lib/sms.ts`

### 6.5 5단계: 기존 파일 수정

1. 게스트 페이지 수정 (인증 상태 확인 로직 추가)
   - 파일: `src/pages/clubs/[id]/guest/index.tsx`
2. 게스트 신청 API 수정 (전화번호 인증 검증 추가)
   - 파일: `src/pages/api/clubs/[id]/guests/apply.ts`

### 6.6 6단계: 통합 및 테스트

1. 전체 플로우 통합
2. 기존 인증된 전화번호 재사용 테스트
3. 전화번호 변경 시나리오 테스트
4. 에러 처리 및 예외 상황 테스트
5. 성능 및 보안 테스트

## 7. 예상 효과 (업데이트)

### 7.1 비즈니스 효과

- 신뢰할 수 있는 신청자 정보 확보
- 스팸 신청 감소
- 클럽 관리자 업무 효율성 향상
- **사용자 편의성 향상으로 신청률 증가**

### 7.2 기술적 효과

- 보안성 강화
- 사용자 경험 개선
- 확장 가능한 인증 시스템 구축
- **데이터 일관성 및 재사용성 향상**

### 7.3 사용자 경험 효과

- **첫 인증 후 재인증 불필요**
- **빠른 신청 프로세스**
- **개인정보 보호 강화**
- **신뢰도 향상**

## 8. 추가 고려사항

### 8.1 데이터 마이그레이션

- 기존 사용자의 전화번호 정보 처리 방안
- 인증되지 않은 전화번호 처리 방안

### 8.2 모니터링 및 분석

- 인증 성공/실패율 모니터링
- 사용자 행동 패턴 분석
- 성능 지표 추적

이 업데이트된 기획서를 바탕으로 구현을 진행하시겠습니까?
